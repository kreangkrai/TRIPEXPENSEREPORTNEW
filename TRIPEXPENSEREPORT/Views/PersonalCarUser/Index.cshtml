@model TRIPEXPENSEREPORT.Models.EmployeeModel
@{
    ViewData["Title"] = "TE : รถส่วนตัว";
    TRIPEXPENSEREPORT.CTLModels.EmployeeModel emp = ViewBag.Employee;
}

<style>

    #table_personal tbody tr:hover {
        cursor: pointer;
        background-color: #f0f8ff !important;
    }

    #table_personal tbody tr.table-selected {
        background-color: #d0e8ff !important;
        font-weight: bold;
    }

    .hidden {
        display: none;
    }

    tr.holiday-row {
        background-color: #e9ecef !important; /* เทาอ่อน */
        /* หรือ #dee2e6, #ced4da ตามชอบ */
    }
</style>


<div class="container-fluid">
    <div class="row">
        <!-- Sidebar (ซ้าย) : Filter -->
        <div class="col-md-2 bg-light p-3 kanit-medium">
            <div class="card border-0 shadow-sm h-0 p-2 rounded-10">
                <h5 class="mb-3" style="letter-spacing:2px; padding:8px; color:white; border-radius:3px; background: #2178BE;
                    background: linear-gradient(90deg, rgba(33, 120, 190, 1) 0%, rgba(40, 71, 95, 1) 100%);">
                    ตัวกรอง
                </h5>

                <div class="mb-2">
                    <label for="month_start" style="color:#555555">เดือน:</label>
                    <input type="month" class="form-control" id="month_start" />
                </div>

                <div class="form-group">
                    <label for="select_driver" style="color:#555555">ชื่อผู้ขับ:</label>
                    <select id="select_driver" class="mb-3 form-control" style="border-radius:5px">
                    </select>
                    <button id="btn_search" class="btn btn-primary w-100 " style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        ค้นหา
                    </button>
                </div>
                <div class="form-group" id="div_export" hidden>
                    <button class="btn btn-success w-100" id="btn_export"
                            style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <i class="fas fa-download"></i>Export
                    </button>
                </div>
            </div>
        </div>
        <!-- Main Content (ขวา) : Table  -->
        <div class="col-md-10 p-3 kanit-regular">
            <h4 style="letter-spacing:2px; padding:10px; padding-left:15px; color:white; border-top-right-radius:20px; border-top-left-radius:20px; background: #2178BE;
        background: linear-gradient(90deg, rgba(33, 120, 190, 1) 0%, rgba(40, 71, 95, 1) 100%);
        display: flex; justify-content: space-between; align-items: center;">
                รถส่วนตัว
               @*  <button class="btn btn-success" data-toggle="modal" data-target="#AddTripModal"
                        style="width:100px; text-align:end; border-radius:20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <i class="fa-solid fa-plus"></i> เพิ่มทริป
                </button> *@
            </h4>
            <!-- Table -->
            <div class="table-responsive-lg" style="height: 700px; overflow-y: auto; border: 1px solid #dee2e6;">
                <table id="table_personal" class="table table-bordered table-hover table-sm compact">
                    <thead class="bg-primary text-white text-center sticky-top" style="position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th>วันที่</th>
                            <th>Job</th>
                            <th>จังหวัด</th>
                            <th>ตั้งแต่เวลา</th>
                            <th>ถึงเวลา</th>
                            <th>การเดินทาง</th>
                            <th>CTBO</th>
                            <th>EXP</th>
                            <th>P/T</th>
                            <th>เลขไมล์เริ่มต้น</th>
                            <th>เลขไมล์สิ้นสุด</th>
                            <th>ระยะทาง</th>
                            <th>รวมระยะทาง</th>
                            <th>รายละเอียด</th>
                            <th>สถานะ</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                    <tfoot class="table-warning text-black fw-bold">
                        <tr>
                            <th colspan="6" class="text-center">ยอดรวมทั้งหมด</th>
                            <th id="totalCTBO" class="text-end">0.00</th>
                            <th id="totalEXP" class="text-end">0.00</th>
                            <th id="totalPT" class="text-end">0.00</th>
                            <th colspan="3"></th>
                            <th id="totalKM" class="text-end">0</th>
                            <th colspan="2"></th>
                        </tr>
                    </tfoot>
                </table>
                <div id="div_summary" hidden>
                <div id="div_summary" class="row">
                    <div class="col-md-5 col-xl-5">
                        <table class="table table-sm table-condensed no-border" style="background-color:grey;height:250px">
                            <tbody>
                                <tr>
                                    <td colspan="2" style="vertical-align:middle">
                                        <span>1)  C = COMPANY'S CAR, T = TAXI, B = BUS, O = OTHER (Pls. specific)</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="vertical-align:middle">
                                        <span>2)  A/EXP = ACTUAL EXPENSES BY COMPANY'S CAR, TAXI, BUS (WITH RECEIPTS IF AVAILABLE)</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="vertical-align:middle">
                                        <span>3)  P/T = PARKING FEE , TOLL FEE (WITH RECEIPT)</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="vertical-align:middle">
                                        <span>4)  OWN CAR  - MILAGE :  START-ENGING =  MILAGE FROM BEGINNING  TO ENDING  PER TRIP  KMS = KILOMETERS MADE PER TRIP</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-right">
                                        <label class="btn btn-primary">
                                            <input id="state_bensin" class="form-control" type="checkbox"> Bensin
                                        </label>
                                    </td>
                                    <td class="text-left">
                                        <label class="btn btn-primary">
                                            <input id="state_diesel" class="form-control" type="checkbox"> Diesel
                                        </label>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-7 col-xl-7">
                        <div style="background-color:#ECF0F5;height:auto;overflow-x:auto">
                            <table class="table compact table-sm table-condensed" id="table_summary" style="border:1px;border-style:solid;border-color:black;border-collapse:collapse;height:250px">
                                <thead style="background-color:white;color:white">
                                    <tr>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
                </div>
            </div>
            <!-- Button below Table -->
            <div class="row kanit-medium d-flex justify-content-center g-0">
                <!-- Button Send & Export -->
                @* <div class="col-md-2 bg-light p-2">
                    <button class="btn btn-success w-100" data-toggle="modal" data-target="#sendModal"
                            style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <i class="fas fa-download"></i> Send & Export
                    </button>
                </div> *@
                <!-- Button Cancel Send -->
                @* <div class="col-md-2 bg-light p-2">
                    <button class="btn btn-danger w-100" data-toggle="modal" data-target="#cancelModal"
                            style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        Cancel Send
                    </button>
                </div> *@
            </div>

            <!-- Modal: Send & Export -->
            <div class="modal fade " id="sendModal" tabindex="-1" role="dialog" aria-labelledby="sendModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">

                        <!-- Modal Header -->
                        <div class="modal-header"
                             style="background: #34ba7c;
                                background: linear-gradient(90deg, rgba(52, 186, 124, 1) 0%, rgba(0, 138, 112, 1) 100%); color: white; border-bottom: none;">
                            <h5 class="modal-title" id="cancelModalLabel">Confirm Send & Export</h5>
                            <!-- Close Button -->
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true" style="color:white">&times;</span>
                            </button>
                        </div>
                        <!-- Modal Body -->
                        <div class="modal-body">
                            <text style="color:#555555">คุณต้องการส่งข้อมูล วันที่ 01/10/2025 - 15/10/2025 ใช่หรือไม่?</text>
                            <label style="color: red; text-align: left; display: block;">
                                * หลังจากผู้ดูแลอนุมัติแล้ว จะไม่สามารถยกเลิกหรือแก้ไขข้อมูลที่ส่งได้
                            </label>

                        </div>
                        <!-- Footer Button -->
                        <div class="modal-footer">

                            <button type="button" class="btn btn-secondary" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" data-dismiss="modal">
                                ปิด
                            </button>
                            <button type="button" id="BtnSendExport" class="btn btn-success" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                ยืนยันการส่ง
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal: Cancel Send -->
            <div class="modal fade" id="cancelModal" tabindex="-1" role="dialog" aria-labelledby="cancelModalLabel" aria-hidden="true">
                <div class="modal-dialog " role="document">
                    <div class="modal-content">
                        <!-- Modal Header -->
                        <div class="modal-header"
                             style="background: #ff2929;
                                 background: linear-gradient(90deg, rgba(255, 41, 41, 1) 0%, rgba(161, 0, 0, 1) 100%); color: white; border-bottom: none;">
                            <h5 class="modal-title" id="cancelModalLabel">Cancel Send</h5>
                            <!-- Close Button -->
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true" style="color:white">&times;</span>
                            </button>
                        </div>
                        <!-- Modal Body -->
                        <div class="modal-body">
                            <text style="color:red; font-size:18px">คุณแน่ใจหรือไม่ว่าต้องการยกเลิกการส่งข้อมูล <br>วันที่ 01/10/2025 - 15/10/2025 </text>
                        </div>
                        <!-- Footer Button -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" data-dismiss="modal">
                                ปิด
                            </button>
                            <button type="button" id="BtnCancelSend" class="btn btn-danger" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                ยืนยันการยกเลิก
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Table -->
<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
        <!-- เพิ่ม modal-lg สำหรับขนาดใหญ่ -->
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(90deg, rgba(33, 120, 190, 1) 0%, rgba(40, 71, 95, 1) 100%); color: white; border-bottom: none;">
                <h5 class="modal-title kanit-regular" id="detailModalLabel">แก้ไขข้อมูล (รถส่วนตัว)</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color: white;">&times;</span>
                </button>
            </div>
            <div class="modal-body kanit-regular" style="color:#444444">
                <form>
                    <div class="form-row">
                        <fieldset hidden class="col-sm-12 col-md-12">
                            <div class="form-group">
                                <label for="edit_code"></label>
                                <input type="text" class="form-control" id="edit_code">
                            </div>
                        </fieldset>
                    </div>
                    <div class="form-row ">
                        <fieldset disabled class="col-sm-12 col-md-4">
                            <div class="form-group">
                                <label for="edit_date">วันที่</label>
                                <input type="text" class="form-control" id="edit_date">
                            </div>
                        </fieldset>
                        <fieldset hidden class="col-sm-12 col-md-4">
                            <div class="form-group">
                                <label for="edit_driver">ผู้ขับรถ</label>
                                <input type="text" class="form-control" id="edit_driver">
                            </div>
                        </fieldset>
                        <fieldset class="col-sm-12 col-md-8">
                            <div class="form-group">
                                <label for="edit_select_province">จังหวัด</label>
                                <select class="form-control" id="edit_select_province">

                                </select>
                            </div>
                        </fieldset>
                    </div>

                    <!-- ROW 2 : ผู้ขับรถ, Job -->
                    <div class="form-row">

                        <div class="form-group col-sm-12 col-md-4">
                            <label for="edit_job">Job</label>
                            <input type="text" class="form-control" id="edit_job">
                        </div>
                        <div class="form-group col-sm-12 col-md-4">
                            <label for="edit_time_start">เวลาเริ่มต้น</label>
                            <input type="time" class="form-control" id="edit_time_start">
                        </div>
                        <div class="form-group col-sm-12 col-md-4">
                            <label for="edit_time_stop">เวลาสิ้นสุด</label>
                            <input type="time" class="form-control" id="edit_time_stop">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-sm-12 col-md-12">
                            <label for="edit_location">การเดินทาง</label>
                            <input type="text" class="form-control" id="edit_location">
                        </div>

                    </div>

                    <div class="form-row">
                        <div class="form-group col-sm-12 col-md-4">
                            <label for="edit_mileage_start">เลขไมล์เริ่มต้น</label>
                            <input type="number" class="form-control" id="edit_mileage_start">
                        </div>
                        <div class="form-group col-sm-12 col-md-4">
                            <label for="edit_mileage_stop">เลขไมล์สิ้นสุด</label>
                            <input type="number" class="form-control" id="edit_mileage_stop">
                        </div>
                        <div class="form-group col-sm-12 col-md-4">
                            <label for="edit_distance">ระยะทาง</label>
                            <div class="input-group">
                                <input type="number" class="form-control" style="text-align:end" id="edit_distance" placeholder="0" disabled>
                                <div class="input-group-append">
                                    <span class="input-group-text">กม.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row ">
                        <div class="form-group col-sm-12 col-md-4">
                            <label for="edit_ctbo">CTBO</label>
                            <div class="input-group">
                                <input type="number" class="form-control" style="text-align:end" id="edit_ctbo" placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text">฿</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-sm-12 col-md-4">
                            <label for="edit_exp">EXP</label>
                            <div class="input-group">
                                <input type="number" class="form-control" style="text-align:end" id="edit_exp" placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text">฿</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-sm-12 col-md-4">
                            <label for="edit_pt">PT</label>
                            <div class="input-group">
                                <input type="number" class="form-control" style="text-align:end" id="edit_pt" placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text">฿</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row ">
                        <fieldset class="col-sm-12 col-md-12">
                            <div class="form-group">
                                <label for="edit_description">รายละเอียด</label>
                                <textarea class="form-control" id="edit_description" rows="2"></textarea>
                            </div>
                        </fieldset>
                    </div>
                    <!-- ROW 8 : อัปเดตล่าสุด, ผู้ดำเนินการ, สถานะ -->
                    @* <div class="form-row ">
                        <fieldset disabled class="col-sm-12 col-md-4">
                            <div class="form-group">
                                <label for="disabledTextInputLastUpdated">อัปเดตล่าสุด</label>
                                <input type="text" class="form-control" id="disabledTextInputLastUpdated" placeholder="08/10/25 09:34">
                            </div>
                        </fieldset>
                        <fieldset disabled class="col-sm-12 col-md-4">
                            <div class="form-group">
                                <label for="disabledTextInputAdmin">ผู้ดำเนินการ</label>
                                <input type="text" class="form-control" id="disabledTextInputAdmin" placeholder="Kriangkrai R.">
                            </div>
                        </fieldset>
                        <fieldset disabled class="col-sm-12 col-md-4">
                            <div class="form-group">
                                <label for="disabledTextInputStatus">สถานะ</label>
                                <input type="text" class="form-control" id="disabledTextInputStatus" placeholder="Manager Pending">
                            </div>
                        </fieldset>
                    </div> *@
                </form>
            </div>
            <!-- Footer Button -->
            <div class="modal-footer kanit-regular">
                <button type="button" id="BtnDelete" class="btn btn-danger col-sm-3 col-md-3" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    ลบ
                </button>
                <button type="button" class="btn btn-outline-danger col-sm-3 col-md-2" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" data-dismiss="modal">
                    ยกเลิก
                </button>
                <button type="button" id="BtnSaveChange" class="btn btn-primary col-sm-3 col-md-3" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    บันทึก
                </button>
            </div>
        </div>
    </div>
</div>

<partial name="ModalSpin" />

@section Scripts {

    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script>
        let personals = [];
        let holidays = [];
        var table_personal;
        let provinces = [];
        let employees = [];
        $(document).ready(async function () {
            const today = new Date();
            const month = today.toISOString().slice(0, 7);

            $('#month_start').val(month);

            let drivers = await Getdrivers();
            const emp = @Html.Raw(Json.Serialize(Model));;
            if (emp.role !== "Admin") {
                drivers = drivers.filter(f => f.emp_id == emp.emp_id).map(m => m);
            }

            if (drivers.length > 0) {
                GenerateDriverOption(drivers);
                $('#btn_search').prop('disabled', false);
            } else {
                alert('ไม่มีข้อมูลในการใช้งาน');
                $('#btn_search').prop('disabled', true);
            }

        });

        async function LoadPersonalCarTable(emp_id, month) {

            const data = await GetPersonalCar(emp_id,month);
            const gasoline = data.gasoline;
            const gasoline_type = data.gasoline_type;
            employees = data.employees;

            let datas = CalSummary(data, gasoline_type, gasoline);
            GenerateSummaryTable(datas);

            holidays = data.holidays;
            provinces = data.provinces;          
            GenerateProvinceOption(provinces);

            const holidayDates = new Set(holidays.map(h => h.date.split('T')[0]));
            table_personal = $('#table_personal').DataTable({
                destroy: true,
                data: data.data,
                order: [[0, 'asc']],
                paging: false,
                info: false,
                searching: false,
                ordering:false,
                        createdRow: function (row, data, dataIndex) {
            const dateDisplay = data.dateDisplay || data.date;

            let year, month, day;
            if (dateDisplay.includes('-')) {
                [year, month, day] = dateDisplay.split('-').map(Number);
            } else if (dateDisplay.includes('/')) {
                [day, month, year] = dateDisplay.split('/').map(Number);
            } else {
                console.error('Invalid date format:', dateDisplay);
                return;
            }
            const date = new Date(Date.UTC(year, month - 1, day));

            const dayOfWeek = date.getUTCDay();
            const dateKey = date.toISOString().split('T')[0];

            const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
            const isHoliday = holidayDates.has(dateKey);

            if (isWeekend || isHoliday) {
                $(row).addClass('table-secondary bg-opacity-50');
            }
        },
                drawCallback: function () {
                    mergeDateRows();
                },
                footerCallback: function (row, data, start, end, display) {
                    const api = this.api();

                    const sum = (columnIndex) => {
                        return api.column(columnIndex, { page: 'all' }).data().reduce((a, b) => {
                            return a + (parseFloat(b) || 0);
                        }, 0);
                    };

                    const totalCTBO = sum(6);
                    const totalEXP = sum(7);
                    const totalPT = sum(8);
                    const totalKM = sum(11);

                    $('#totalCTBO').html(totalCTBO.toLocaleString('th-TH', { minimumFractionDigits: 0 }));
                    $('#totalEXP').html(totalEXP.toLocaleString('th-TH', { minimumFractionDigits: 0 }));
                    $('#totalPT').html(totalPT.toLocaleString('th-TH', { minimumFractionDigits: 0 }));
                    $('#totalKM').html(totalKM.toLocaleString('th-TH')).css({
                        'vertical-align': 'middle',
                        'font-size': '20px',
                        'text-align': 'center'
                    });
                },
                columns: [
                    { data: 'dateDisplay', className: 'text-center fw-bold' },
                    { data: 'job', className: 'text-center' },
                    { data: 'province' ,className: 'text-center' },
                    {
                        data: 'timeStart', className: 'text-center',
                        render: function (data) {
                            return data === "00:00" ? '' : data;
                        }
                    },
                    {
                        data: 'timeStop', className: 'text-center',
                        render: function (data) {
                            return data === "00:00" ? '' : data;
                        }
                    },
                    { data: 'location' },
                    {
                        data: 'ctbo',
                        className: 'text-center',
                        render: function (data) {
                            return data || '';
                        }
                        //render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'exp',
                        className: 'text-center',
                        render: function (data) {
                            return data || '';
                        }
                        //render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'pt',
                        className: 'text-center',
                        render: function (data) {
                            return data || '';
                        }
                        //render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'mileage_start',
                        className: 'text-center',
                        render: function (data) {
                            return data || '';
                        }
                        //render: $.fn.dataTable.render.number(',', '.', 0)
                    },
                    {
                        data: 'mileage_stop',
                        className: 'text-center',
                        render: function (data) {
                            return data || '';
                        }
                        //render: $.fn.dataTable.render.number(',', '.', 0)
                    },
                    {
                        data: 'km',
                        className: 'text-center fw-bold',
                        render: function (data) {
                            return data || '';
                        }
                        //render: data => data ? data.toLocaleString('th-TH') : '0'
                    },
                    {
                        data: null,
                        className: 'text-center fw-bold',
                        defaultContent: '',
                    },
                    { data: 'description' },
                    {
                        data: 'status',
                        className: 'text-center',
                        render: function (data) {
                            const badges = {
                                'Approved': 'bg-success',
                                'Pending': 'bg-info'
                            };
                            const cls = badges[data] || 'bg-secondary';
                            return `<span class="badge ${cls}">${data || ''}</span>`;
                        }
                    }
                ]

            });

            $('#table_personal tbody').on('click', 'tr', function () {
                
                const rowData = table_personal.row(this).data();
                if (rowData.status !== "Approved"){
                if (!rowData) {
                    const $row = $(this);
                    const prevRowData = table_personal.row($row.prev()).data();
                    if (prevRowData) rowData = prevRowData;
                }

                if (rowData) {
                    $(this).toggleClass('table-selected');

                    let code = rowData.code;
                    const date = rowData.dateDisplay;
                    let driver = rowData.driver;
                    const job = rowData.job;
                    const time_start = rowData.timeStart;
                    const time_stop = rowData.timeStop;
                    const location = rowData.location;
                    const mileage_start = rowData.mileage_start;
                    const mileage_stop = rowData.mileage_stop;
                    const distance = rowData.km;
                    const ctbo = rowData.ctbo;
                    const exp = rowData.exp;
                    const pt = rowData.pt;
                    const description = rowData.description;
                    if (driver === ""){
                        driver = $('#select_driver').val();
                        code = driver + "" + formatDateTimeYYYYMMDDHHMMSS();
                    }


                    $('#edit_code').val(code);
                    $('#edit_date').val(date);
                    $('#edit_driver').val(driver);
                    $('#edit_job').val(job);
                    $('#edit_time_start').val(time_start);
                    $('#edit_time_stop').val(time_stop);
                    $('#edit_location').val(location);
                    $('#edit_mileage_start').val(mileage_start);
                    $('#edit_mileage_stop').val(mileage_stop);
                    $('#edit_distance').val(distance);
                    $('#edit_ctbo').val(ctbo);
                    $('#edit_exp').val(exp);
                    $('#edit_pt').val(pt);
                    $('#edit_description').val(description);
                    $('#edit_select_province').val(rowData.zipcode);
                    $('#detailModal').modal();
                }
                }else{
                    alert('ข้อมูลถูกตรวจสอบแล้ว ไม่สามารถแก้ไขได้');
                }
            });
            mergeDateRows();
        }

        $('#edit_mileage_start , #edit_mileage_stop').on('change' ,function(){
            const start = parseInt($('#edit_mileage_start').val());
            const stop = parseInt($('#edit_mileage_stop').val());
            const distance = stop - start;
            $('#edit_distance').val(distance);
        });

        $('#BtnDelete').on('click',async function(){
            const code = $('#edit_code').val();
            await $.ajax({
                type: "DELETE",
                url: '@Url.Action("DeleteData", "PersonalCarUser")',
                contentType: 'application/x-www-form-urlencoded',
                data: { code },
                success: function (response) {
                     if (response === "Success"){
                         const emp_id = $('#select_driver').val();
                         const month = $('#month_start').val();
                         LoadPersonalCarTable(emp_id, month);

                      }else{
                          alert(response);
                      }
                }
            });
            $('#detailModal').modal('hide');
        });

        $('#BtnSaveChange').on('click',async function(){
             const zipcode = $('#edit_select_province').val();
            if (zipcode !== null) {
                const code = $('#edit_code').val();
                const date = ddMMyyyyToISO($('#edit_date').val());
                const driver = $('#edit_driver').val();
                const job = $('#edit_job').val();
                const time_start = $('#edit_time_start').val();
                const time_stop = $('#edit_time_stop').val();
                const location = $('#edit_location').val();
                const mileage_start = $('#edit_mileage_start').val();
                const mileage_stop = $('#edit_mileage_stop').val();
                const distance = $('#edit_distance').val();
                const ctbo = $('#edit_ctbo').val();
                const exp = $('#edit_exp').val();
                const pt = $('#edit_pt').val();
                const description = $('#edit_description').val();

                const str = JSON.stringify({
                    'code': code,
                    'date': date,
                    'driver': driver,
                    'job': job,
                    'time_start': time_start,
                    'time_stop': time_stop,
                    'location': location,
                    'mileage_start': mileage_start,
                    'mileage_stop': mileage_stop,
                    'km': distance,
                    'ctbo': ctbo,
                    'exp': exp,
                    'pt': pt,
                    'description': description,
                    'zipcode': zipcode
                });

                await $.ajax({
                    type: "POST",
                    url: '@Url.Action("UpdateData", "PersonalCarUser")',
                    contentType: 'application/x-www-form-urlencoded',
                    data: { str },
                    success: function (response) {
                        if (response === "Success") {
                            const emp_id = $('#select_driver').val();
                            const month = $('#month_start').val();
                            LoadPersonalCarTable(emp_id, month);

                        } else {
                            alert(response);
                        }
                    }
                });
                $('#detailModal').modal('hide');
            }else{
                alert('ไม่มีจังหวัด');
            }
        });


        async function GetPersonalCar(emp_id, month) {
            const $modal = $('#SpinModal');
            $modal.modal('show');

            try {
                const response = await $.ajax({
                    type: "GET",
                    url: '@Url.Action("GetDataPersonalCar", "PersonalCarUser")',
                    dataType: "json",
                    data: { emp_id, month },
                });

                return response;

            } catch (err) {
                return null;

            } finally {
                $modal.modal('hide');
            }
        }

        $('#month_start').on('change',async function(){
            const driver = await Getdrivers();
            GenerateDriverOption(driver);
        });

        $('#btn_search').on('click', function () {
            const emp_id = $('#select_driver').val();
            const month = $('#month_start').val();

            if (emp_id !== "" && emp_id !== null) {
                LoadPersonalCarTable(emp_id, month);
            } else {
                alert('Please Select Driver');
            }
            
            $('#div_summary').prop('hidden',false);
            $('#div_export').prop('hidden',false);
        });

        async function Getdrivers() {
            let drivers = [];
            const month = $('#month_start').val();
            await $.ajax({
                type: "GET",
                url: '@Url.Action("Getdrivers", "PersonalCarUser")',
                contentType: 'application/x-www-form-urlencoded',
                data: { month },
                success: function (response) {
                    drivers = response;
                }
            });
            return drivers;
        }
        function ddMMyyyyToISO(dateStr) {
            if (!dateStr || typeof dateStr !== 'string' || !dateStr.includes('/')) {
                return dateStr || '';
            }

            const parts = dateStr.trim().split('/');
            if (parts.length !== 3) return dateStr;

            const [dd, mm, yyyy] = parts.map(p => p.trim());

            // เผื่อเลขเดือน/วันไม่มี 0 นำหน้า
            const paddedDD = dd.padStart(2, '0');
            const paddedMM = mm.padStart(2, '0');

            return `${yyyy}-${paddedMM}-${paddedDD}`;
        }

        function mergeDateRows() {
            const api = table_personal;
            if (!api || api.rows().count() === 0) return;

            const dateColIdx = 0;
            const sumKmColIdx = 12;

            let currentGroupDate = null;
            let groupRows = [];
            let groupTotalKm = 0;

            api.rows({ page: 'current' }).nodes().to$().each(function () {
                const $row = $(this);
                const rowData = api.row(this).data();
                if (!rowData) return;

                const thisDate = rowData.dateDisplay;

                if (currentGroupDate !== thisDate) {

                    if (groupRows.length > 0) {
                        applyGroupMerge(groupRows, groupTotalKm, dateColIdx, sumKmColIdx);
                    }
                    currentGroupDate = thisDate;
                    groupRows = [$row];
                    groupTotalKm = rowData.km || 0;
                } else {
                    groupRows.push($row);
                    groupTotalKm += rowData.km || 0;
                }
            });

            if (groupRows.length > 0) {
                applyGroupMerge(groupRows, groupTotalKm, dateColIdx, sumKmColIdx);
            }
        }

        function applyGroupMerge(groupRows, totalKm, dateColIdx, sumKmColIdx) {
            const rowCount = groupRows.length;
            const $firstRow = groupRows[0];

            $firstRow.find('td').eq(dateColIdx)
                .attr('rowspan', rowCount)
                .css({ 'vertical-align': 'middle', 'background-color': '#e3f2fd', 'font-weight': '500' });

            if (totalKm === 0) {
                $firstRow.find('td').eq(sumKmColIdx)
                    .attr('rowspan', rowCount)
                    .html(`<strong style="color:#d84315; font-size:1em;"></strong>`)
                    .css({
                        'vertical-align': 'middle',
                        'background-color': '#ffffff',
                        'text-align': 'center'
                    });
            }else{
                $firstRow.find('td').eq(sumKmColIdx)
                .attr('rowspan', rowCount)
                .html(`<strong style="color:#d84315; font-size:1em;">${totalKm.toLocaleString('th-TH')}</strong>`)
                .css({
                    'vertical-align': 'middle',
                    'background-color': '#ffffff',
                    'text-align': 'center',
                    'font-weight': '500'
                });
            }

            if (rowCount > 1) {
                for (let i = 1; i < groupRows.length; i++) {
                    groupRows[i].find('td').eq(dateColIdx).remove();
                    groupRows[i].find('td').eq(sumKmColIdx).remove();
                }
            }
        }

        async function GenerateDriverOption(drivers) {
            $('#select_driver').empty();
            $('#select_driver').append(`<option value="" selected disabled>Please Select Driver</option>`);
            for (let i = 0; i < drivers.length; i++) {
                $('#select_driver').append(`<option value="${drivers[i].emp_id}">${drivers[i].name}</option>`);
            }
        }

        async function GenerateProvinceOption(provinces) {
            $('#edit_select_province').empty();
            $('#edit_select_province').append(`<option value="" selected disabled>Please Select Province</option>`);
            for (let i = 0; i < provinces.length; i++) {
                $('#edit_select_province').append(`<option value="${provinces[i].zipcode}">${provinces[i].province}-${provinces[i].zipcode}</option>`);
            }
        }

        function formatDateTimeYYYYMMDDHHMMSS(date = new Date()) {
            const pad = (n) => String(n).padStart(2, '0');

            return (
                date.getFullYear() +
                pad(date.getMonth() + 1) +
                pad(date.getDate()) +
                pad(date.getHours()) +
                pad(date.getMinutes()) +
                pad(date.getSeconds())
            );
        }

        $('#state_bensin').on('change',async function(){
            $('#state_diesel').prop('checked',false);
            const emp_id = $('#select_driver').val();
                         const month = $('#month_start').val();
            const gasoline_type = "Bensin";
            await $.ajax({
                type: "POST",
                url: '@Url.Action("UpdatePersonalGasoline", "PersonalCarUser")',
                contentType: 'application/x-www-form-urlencoded',
                data: { emp_id,month,gasoline_type },
                success: function (response) {
                     if (response === "Success"){                        
                         LoadPersonalCarTable(emp_id, month);

                      }else{
                          alert(response);
                      }
                }
            });

        });

        $('#state_diesel').on('change',async function(){
             $('#state_bensin').prop('checked',false);
             const emp_id = $('#select_driver').val();
             const month = $('#month_start').val();
            const gasoline_type = "Diesel";
            await $.ajax({
                type: "POST",
                url: '@Url.Action("UpdatePersonalGasoline", "PersonalCarUser")',
                contentType: 'application/x-www-form-urlencoded',
                data: { emp_id,month,gasoline_type },
                success: function (response) {
                     if (response === "Success"){
                         
                         LoadPersonalCarTable(emp_id, month);

                      }else{
                          alert(response);
                      }
                }
            });
        });

        function CalSummary(data_personal, Gastype,commensurate) {
           
                var a1 = [];
                var a2 = [];
                var a3 = [];
                var a4 = [];
                var a5 = [];
                var a6 = [];
                var a7 = [];
                var a8 = [];
                var ans = [];
                var suma1 = 0;
                var suma2 = 0;
                var suma3 = 0;
                var suma4 = 0;
                var suma5 = 0;
                var suma6 = 0;

                 const data = data_personal.data;

                 const sumKm = data.reduce((acc, curr) => {
                      return acc + (Number(curr.km) || 0);
                    }, 0);
                const sumEXP_PT = data.reduce((acc, curr) => {
                  const exp = Number(curr.exp) || 0;
                  const pt  = Number(curr.pt)  || 0;

                  return {
                    sumEXP: acc.sumEXP + exp,
                    sumPT:  acc.sumPT  + pt
                  };
                }, { sumEXP: 0, sumPT: 0 });

                const emp_id =  $('#select_driver').val();
                const emp = employees.filter(f=>f.emp_id === emp_id).map(m=>m)[0];

                if (Gastype.gasoline_type == "Bensin") {
                    $('#state_bensin').prop('checked',true);
                    $('#state_diesel').prop('checked',false);
                }
                else if (Gastype.gasoline_type == "Diesel"){
                     $('#state_bensin').prop('checked',false);
                    $('#state_diesel').prop('checked',true);
                }

                if (emp.position.includes('Operation')) {
                    if (sumKm <= 1000) {                       
                        suma1 = sumKm * 10.0;
                        a1 = ["(0 ~ 1,000 KMS)  10.0 B/KMS", "KMS__", sumKm.toString(), "AMOUNT", suma1.toString(), "BAHT"];
                    } else {
                        suma1 = 1000 * 10.0;
                        a1 = ["(0 ~ 1,000 KMS)  10.0 B/KMS", "KMS__", "1000", "AMOUNT", suma1.toString(), "BAHT"];
                    }
                    if (sumKm > 1000 && sumKm <= 2000) {
                        suma2 = (sumKm - 1000) * 7.5;
                        a2 = ["(1,001 ~ 2,000 KMS)  7.5 B/KMS", "KMS__", (sumKm - 1000).toString(), "AMOUNT", suma2.toString(), "BAHT"];
                    } else {
                        if (sumKm > 2000) {
                            suma2 = 1000 * 7.5;
                            a2 = ["(1,001 ~ 2,000 KMS)  7.5 B/KMS", "KMS__", "1000", "AMOUNT", suma2.toString(), "BAHT"];
                        } else {
                            suma2 = 0;
                            a2 = ["(1,001 ~ 2,000 KMS)  7.5 B/KMS", "KMS__", "0", "AMOUNT", suma2.toString(), "BAHT"];
                        }
                    }

                    if (sumKm > 2000 && sumKm <= 4000) {
                        suma3 = (sumKm - 2000) * 5;
                        a3 = ["(2,001 ~ 4,000 KMS)  5.0 B/KMS", "KMS__", (sumKm - 2000).toString(), "AMOUNT", suma3.toString(), "BAHT"];
                    } else {
                        if (sumKm > 4000) {
                            suma3 = 2000 * 5;
                            a3 = ["(2,001 ~ 4,000 KMS)  5.0 B/KMS", "KMS__", "2000", "AMOUNT", suma3.toString(), "BAHT"];
                        } else {
                            suma3 = 0;
                            a3 = ["(2,001 ~ 4,000 KMS)  5.0 B/KMS", "KMS__", "0", "AMOUNT", suma3.toString(), "BAHT"];
                        }
                    }
                    if (sumKm > 4000) {
                        suma4 = (sumKm - 4000) * 4;
                        a4 = ["(4,001 ~ ……...KMS)  4.0 B/KMS", "KMS__", (sumKm - 4000).toString(), "AMOUNT", suma4.toString(), "BAHT"];
                    } else {
                        suma4 = 0;
                        a4 = ["(4,001 ~ ……...KMS)  4.0 B/KMS", "KMS__", "0", "AMOUNT", suma4.toString(), "BAHT"];
                    }

                    // Sum A/EXP, P_T
                    suma5 = sumEXP_PT.sumEXP + sumEXP_PT.sumPT;
                    a5 = ["", "A/EXP + P/T", "", "AMOUNT", suma5.toString(), "BAHT"];

                    // Sum COMMENSURATE GASOLINE

                    if (Gastype.gasoline_type == "Bensin") {
                        suma6 = ((sumKm / 10.0) * (commensurate.sohol - 35)).toFixed(2);
                    }else if (Gastype.gasoline_type == "Diesel"){
                        suma6 = ((sumKm / 10.0) * (commensurate.diesel - 35)).toFixed(2);
                    }
                    a6 = ["", "COMMENSURATE GASOLINE", "", "AMOUNT", suma6.toString(), "BAHT"];

                    // Gasoline
                    if (Gastype.gasoline_type == "Bensin") {
                        a7 = ["", "Bensin", commensurate.sohol.toString(), "", "", ""];
                    } else if (Gastype.gasoline_type == "Diesel") {
                        a7 = ["", "Diesel", commensurate.diesel.toString(), "", "", ""];
                    } else {
                        a7 = ["", "", "0.0", "", "", ""];
                    }

                    // Sum Total
                    var sumall = suma1 + suma2 + suma3 + suma4 + suma5 + parseFloat(suma6);
                    a8 = ["", "", "", "TOTAL", sumall.toString(), "BAHT"];
                }
                else if (emp.position.includes('Manager') || emp.position.includes('Director')){
                    if (sumKm <= 1000) {
                        suma1 = 0;
                        a1 = ["(0 ~ 1,000 KMS)  10.0 B/KMS", "KMS__", "0", "AMOUNT", suma1.toString(), "BAHT"];
                    } else {
                        suma1 = 0;
                        a1 = ["(0 ~ 1,000 KMS)  10.0 B/KMS", "KMS__", "0", "AMOUNT", suma1.toString(), "BAHT"];
                    }

                    if (sumKm > 1000 && sumKm <= 2000) {
                        suma2 = 0;
                        a2 = ["(1001 ~ 2,000 KMS)  7.5 B/KMS", "KMS__", "0", "AMOUNT", suma2.toString(), "BAHT"];
                    } else {
                        suma2 = 0;
                        a2 = ["(1001 ~ 2,000 KMS)  7.5 B/KMS", "KMS__", "0", "AMOUNT", suma2.toString(), "BAHT"];
                    }

                    if (sumKm > 2000 && sumKm <= 4000) {
                        suma3 = 0;
                        a3 = ["(2,001 ~ 4,000 KMS)  5.0 B/KMS", "KMS__", "0", "AMOUNT", suma3.toString(), "BAHT"];
                    } else {
                        if (sumKm > 4000) {
                            suma3 = 0;
                            a3 = ["(2,001 ~ 4,000 KMS)  5.0 B/KMS", "KMS__", "0", "AMOUNT", suma3.toString(), "BAHT"];
                        } else {
                            suma3 = 0;
                            a3 = ["(2,001 ~ 4,000 KMS)  5.0 B/KMS", "KMS__", "0", "AMOUNT", suma3.toString(), "BAHT"];
                        }
                    }
                    if (sumKm > 4000) {
                        suma4 = 0;
                        a4 = ["(4,001 ~ ……...KMS)  4.0 B/KMS", "KMS__", "0", "AMOUNT", suma4.toString(), "BAHT"];
                    } else {
                        suma4 = 0;
                        a4 = ["(4,001 ~ ……...KMS)  4.0 B/KMS", "KMS__", "0", "AMOUNT", suma4.toString(), "BAHT"];
                    }

                    // Sum A/EXP, P_T
                    suma5 = 0;
                    a5 = ["", "A/EXP + P/T", "", "AMOUNT", suma5.toString(), "BAHT"];

                    // Sum COMMENSURATE GASOLINE
                    suma6 = 0;
                    a6 = ["", "COMMENSURATE GASOLINE", "", "AMOUNT", suma6.toString(), "BAHT"];

                    // Gasoline
                    a7 = ["", "", "0.0", "", "", ""];

                    // Sum Total
                    var sumall = suma1 + suma2 + suma3 + suma4 + suma5 + parseFloat(suma6);
                    a8 = ["", "", "", "TOTAL", sumall.toString(), "BAHT"];
                }
                else {
                    if (sumKm <= 1000) {
                        suma1 = 0;
                        a1 = ["(0 ~ 1,000 KMS)  10.0 B/KMS", "KMS__", "0", "AMOUNT", suma1.toString(), "BAHT"];
                    } else {
                        suma1 = 1000 * 10.0;
                        a1 = ["(0 ~ 1,000 KMS)  10.0 B/KMS", "KMS__", "1000", "AMOUNT", suma1.toString(), "BAHT"];
                    }
                    if (sumKm > 1000 && sumKm <= 2000) {
                        suma2 = 0;
                        a2 = ["(1001 ~ 2,000 KMS)  7.5 B/KMS", "KMS__", "0", "AMOUNT", suma2.toString(), "BAHT"];
                    } else {
                        suma2 = 2000 * 7.5;
                        a2 = ["(1001 ~ 2,000 KMS)  7.5 B/KMS", "KMS__", "1000", "AMOUNT", suma2.toString(), "BAHT"];
                    }

                    if (sumKm > 2000 && sumKm <= 4000) {
                        suma3 = 0;
                        a3 = ["(2,001 ~ 4,000 KMS)  5.0 B/KMS", "KMS__", "0", "AMOUNT", suma3.toString(), "BAHT"];
                    } else {
                        if (sumKm > 4000) {
                            suma3 = 0;
                            a3 = ["(2,001 ~ 4,000 KMS)  5.0 B/KMS", "KMS__", "2000", "AMOUNT", suma3.toString(), "BAHT"];
                        } else {
                            suma3 = 0;
                            a3 = ["(2,001 ~ 4,000 KMS)  5.0 B/KMS", "KMS__", "0", "AMOUNT", suma3.toString(), "BAHT"];
                        }
                    }
                    if (sumKm > 4000) {
                        suma4 = 0;
                        a4 = ["(4,001 ~ ……...KMS)  4.0 B/KMS", "KMS__", "0", "AMOUNT", suma4.toString(), "BAHT"];
                    } else {
                        suma4 = 0;
                        a4 = ["(4,001 ~ ……...KMS)  4.0 B/KMS", "KMS__", "0", "AMOUNT", suma4.toString(), "BAHT"];
                    }

                    // Sum A/EXP, P_T
                    suma5 = 0;
                    a5 = ["", "A/EXP + P/T", "", "AMOUNT", suma5.toString(), "BAHT"];

                    // Sum COMMENSURATE GASOLINE
                    suma6 = 0;
                    a6 = ["", "COMMENSURATE GASOLINE", "", "AMOUNT", suma6.toString(), "BAHT"];

                    // Gasoline
                    a7 = ["", "", "0.0", "", "", ""];

                    // Sum Total
                    var sumall = 3000;
                    a8 = ["", "", "", "TOTAL", sumall.toString(), "BAHT"];
                }
                ans = [a1, a2, a3, a4, a5, a6, a7, a8];

                return ans;
            }

            let table_summary;
            function GenerateSummaryTable(_datas) {
                let datas = [];
                for (let i = 0; i < _datas.length; i++) {
                    datas.push([_datas[i][0], _datas[i][1], _datas[i][2], _datas[i][3], _datas[i][4], _datas[i][5]]);
                }
                if (table_summary !== undefined) {
                    table_summary.destroy();
                }
                table_summary = $('#table_summary').DataTable({
                    data: datas,
                    columnDefs: [
                        {
                            //targets: [2],
                            //className: "dt-left",
                        },
                    ],
                    ordering: false,
                    searching: false,
                    paging: false,
                    info: false,
                    rowCallback: function (row, data) {
                        let amount = data[3];
                        if (amount === "TOTAL") {
                            $('td', row).css("font-weight", "bold");
                            $('td', row).css("text-align", "center");
                        }
                    }
                });
            };

            $('#btn_export').on('click', function () {
             const emp_id = $('#select_driver').val();
             const month = $('#month_start').val();
            location.href = '@Url.Action("Export", "PersonalCarUser")?emp_id='+ emp_id + '&month=' + month;
        });
    </script>
}