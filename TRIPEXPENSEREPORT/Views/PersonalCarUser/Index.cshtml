@model List<TRIPEXPENSEREPORT.Models.PersonalModel>
@{
    ViewData["Title"] = "TE : รถส่วนตัว";
}

<style>

    #table_personal tbody tr:hover {
        cursor: pointer;
        background-color: #f0f8ff !important;
    }

    #table_personal tbody tr.table-selected {
        background-color: #d0e8ff !important;
        font-weight: bold;
    }

    .hidden {
        display: none;
    }
</style>


<div class="container-fluid">
    <div class="row">
        <!-- Sidebar (ซ้าย) : Filter -->
        <div class="col-md-2 bg-light p-3 kanit-medium">
            <div class="card border-0 shadow-sm h-0 p-2 rounded-10">
                <h5 class="mb-3" style="letter-spacing:2px; padding:8px; color:white; border-radius:3px; background: #2178BE;
                    background: linear-gradient(90deg, rgba(33, 120, 190, 1) 0%, rgba(40, 71, 95, 1) 100%);">
                    ตัวกรอง
                </h5>

                <div class="mb-2">
                    <label for="date_start" style="color:#555555">วันที่เริ่มต้น:</label>
                    <input type="date" class="form-control" id="date_start" placeholder="วันที่ (dd/mm/yyyy)" />
                </div>

                <div class="mb-2">
                    <label for="date_end" style="color:#555555">วันที่สิ้นสุด:</label>
                    <input type="date" class="form-control" id="date_end" placeholder="วันที่ (dd/mm/yyyy)" />
                </div>

                <div class="form-group">
                    <label for="employee" style="color:#555555" id="employee-label">ชื่อผู้ขับ:</label>
                    <select id="select_driver" class="mb-3 form-control" style="border-radius:5px">
                    </select>
                    <button id="btn_search" class="btn btn-primary w-100 " style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        ค้นหา
                    </button>
                </div>
            </div>
        </div>
        <!-- Main Content (ขวา) : Table  -->
        <div class="col-md-10 p-3 kanit-regular">
            <h4 style="letter-spacing:2px; padding:10px; padding-left:15px; color:white; border-top-right-radius:20px; border-top-left-radius:20px; background: #2178BE;
        background: linear-gradient(90deg, rgba(33, 120, 190, 1) 0%, rgba(40, 71, 95, 1) 100%);
        display: flex; justify-content: space-between; align-items: center;">
                รถส่วนตัว
                <button class="btn btn-success" data-toggle="modal" data-target="#AddTripModal"
                        style="width:100px; text-align:end; border-radius:20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <i class="fa-solid fa-plus"></i> เพิ่มทริป
                </button>
            </h4>

            <!-- Add Trip Modal -->
            <div class="modal fade" id="AddTripModal" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-md" role="document">
                    <!-- เพิ่ม modal-lg สำหรับขนาดใหญ่ -->
                    <div class="modal-content">
                        <div class="modal-header" style="background: #34ba7c;
                                background: linear-gradient(90deg, rgba(52, 186, 124, 1) 0%, rgba(0, 138, 112, 1) 100%); color: white; border-bottom: none;">
                            <h5 class="modal-title kanit-regular" id="detailModalLabel">เพิ่มข้อมูล (รถบริษัท)</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true" style="color: white;">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body kanit-regular" style="color:#444444">
                            <form>
                                <!-- ROW 1 : วันที่, ผู้ขับรถ -->
                                <div class="form-row ">
                                    <div class="form-group col-sm-12 col-md-6">
                                        <label for="InputDate">วันที่</label>
                                        <input type="date" class="form-control" id="InputDate">
                                    </div>
                                    <div class="form-group col-sm-12 col-md-6">
                                        <label for="SelectDriver">ผู้ขับ</label>
                                        <select class="form-control" id="SelectDriver">
                                            <option value="NULL">Please Select...</option>
                                            <option value="EM001">Sarit T.</option>
                                            <option value="EM002">Kriangkrai R.</option>
                                            <option value="EM003">Jirawat J.</option>
                                            <option value="EM004">Chakrit R.</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- ROW 2 : รถบริษัท, ทะเบียนรถ -->
                                <div class="form-row ">

                                    <div class="form-group col-sm-12 col-md-6">
                                        <label for="car" style="color:#555555" id="car-label">รถบริษัท:</label>
                                        <select name="cars" id="car" class="form-control" style="border-radius:5px">
                                            <option value="NULL">Please Select...</option>
                                            <option value="CAR01">CAR#01</option>
                                            <option value="CAR02">CAR#02</option>
                                            <option value="CAR03">CAR#03</option>
                                            <option value="CAR04">CAR#04</option>
                                        </select>
                                    </div>

                                    <fieldset disabled class="col-sm-12 col-md-6">
                                        <div class="form-group">
                                            <label for="disabledTextInputLicensePlate">ป้ายทะเบียนรถ</label>
                                            <input type="text" class="form-control" id="disabledTextInputLicensePlate" placeholder="กก-0000">
                                        </div>
                                    </fieldset>
                                </div>
                            </form>
                        </div>
                        <!-- Footer Button -->
                        <div class="modal-footer kanit-regular">
                            <button type="button" class="btn btn-outline-danger col-sm-3 col-md-2" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" data-dismiss="modal">
                                ยกเลิก
                            </button>
                            <button type="button" id="BtnAddTrip" class="btn btn-success col-sm-3 col-md-2" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                <i class="fa-solid fa-plus"></i> เพิ่ม
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive-lg" style="height: 700px; overflow-y: auto; border: 1px solid #dee2e6;">
                <table id="table_personal" class="table table-bordered table-hover table-sm compact">
                    <thead class="bg-primary text-white text-center sticky-top" style="position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th>วันที่</th>
                            <th>Job</th>
                            <th>ตั้งแต่เวลา</th>
                            <th>ถึงเวลา</th>
                            <th>การเดินทาง</th>
                            <th>CTBO</th>
                            <th>EXP</th>
                            <th>P/T</th>
                            <th>เลขไมล์เริ่มต้น</th>
                            <th>เลขไมล์สิ้นสุด</th>
                            <th>ระยะทาง</th>
                            <th>รวมระยะทาง</th>
                            <th>รายละเอียด</th>
                            <th>สถานะ</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                    <tfoot class="table-warning text-black fw-bold">
                        <tr>
                            <th colspan="5" class="text-center">ยอดรวมทั้งหมด</th>
                            <th id="totalCTBO" class="text-end">0.00</th>
                            <th id="totalEXP" class="text-end">0.00</th>
                            <th id="totalPT" class="text-end">0.00</th>
                            <th colspan="3"></th>
                            <th id="totalKM" class="text-end">0</th>
                            <th colspan="2"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <!-- Button below Table -->
            <div class="row kanit-medium d-flex justify-content-center g-0">
                <!-- Button Send & Export -->
                <div class="col-md-2 bg-light p-2">
                    <button class="btn btn-success w-100" data-toggle="modal" data-target="#sendModal"
                            style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <i class="fas fa-download"></i> Send & Export
                    </button>
                </div>
                <!-- Button Cancel Send -->
                <div class="col-md-2 bg-light p-2">
                    <button class="btn btn-danger w-100" data-toggle="modal" data-target="#cancelModal"
                            style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        Cancel Send
                    </button>
                </div>
            </div>

            <!-- Modal: Send & Export -->
            <div class="modal fade " id="sendModal" tabindex="-1" role="dialog" aria-labelledby="sendModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">

                        <!-- Modal Header -->
                        <div class="modal-header"
                             style="background: #34ba7c;
                                background: linear-gradient(90deg, rgba(52, 186, 124, 1) 0%, rgba(0, 138, 112, 1) 100%); color: white; border-bottom: none;">
                            <h5 class="modal-title" id="cancelModalLabel">Confirm Send & Export</h5>
                            <!-- Close Button -->
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true" style="color:white">&times;</span>
                            </button>
                        </div>
                        <!-- Modal Body -->
                        <div class="modal-body">
                            <text style="color:#555555">คุณต้องการส่งข้อมูล วันที่ 01/10/2025 - 15/10/2025 ใช่หรือไม่?</text>
                            <label style="color: red; text-align: left; display: block;">
                                * หลังจากผู้ดูแลอนุมัติแล้ว จะไม่สามารถยกเลิกหรือแก้ไขข้อมูลที่ส่งได้
                            </label>

                        </div>
                        <!-- Footer Button -->
                        <div class="modal-footer">

                            <button type="button" class="btn btn-secondary" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" data-dismiss="modal">
                                ปิด
                            </button>
                            <button type="button" id="BtnSendExport" class="btn btn-success" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                ยืนยันการส่ง
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal: Cancel Send -->
            <div class="modal fade" id="cancelModal" tabindex="-1" role="dialog" aria-labelledby="cancelModalLabel" aria-hidden="true">
                <div class="modal-dialog " role="document">
                    <div class="modal-content">
                        <!-- Modal Header -->
                        <div class="modal-header"
                             style="background: #ff2929;
                                 background: linear-gradient(90deg, rgba(255, 41, 41, 1) 0%, rgba(161, 0, 0, 1) 100%); color: white; border-bottom: none;">
                            <h5 class="modal-title" id="cancelModalLabel">Cancel Send</h5>
                            <!-- Close Button -->
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true" style="color:white">&times;</span>
                            </button>
                        </div>
                        <!-- Modal Body -->
                        <div class="modal-body">
                            <text style="color:red; font-size:18px">คุณแน่ใจหรือไม่ว่าต้องการยกเลิกการส่งข้อมูล <br>วันที่ 01/10/2025 - 15/10/2025 </text>
                        </div>
                        <!-- Footer Button -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" data-dismiss="modal">
                                ปิด
                            </button>
                            <button type="button" id="BtnCancelSend" class="btn btn-danger" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                ยืนยันการยกเลิก
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Table -->
<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
        <!-- เพิ่ม modal-lg สำหรับขนาดใหญ่ -->
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(90deg, rgba(33, 120, 190, 1) 0%, rgba(40, 71, 95, 1) 100%); color: white; border-bottom: none;">
                <h5 class="modal-title kanit-regular" id="detailModalLabel">แก้ไขข้อมูล (รถส่วนตัว)</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color: white;">&times;</span>
                </button>
            </div>
            <div class="modal-body kanit-regular" style="color:#444444">
                <form>
                    <!-- ROW 1 : วันที่, รถบริษัท, ทะเบียนรถ -->
                    <div class="form-row ">
                        <fieldset disabled class="col-sm-12 col-md-4">
                            <div class="form-group">
                                <label for="disabledTextInputDate">วันที่</label>
                                <input type="text" class="form-control" id="disabledTextInputDate" placeholder="08/10/2025">
                            </div>
                        </fieldset>
                        <fieldset disabled class="col-sm-12 col-md-4">
                            <div class="form-group">
                                <label for="disabledTextInputCar">รถบริษัท</label>
                                <input type="text" class="form-control" id="disabledTextInputCar" placeholder="CAR#99">
                            </div>
                        </fieldset>
                        <fieldset disabled class="col-sm-12 col-md-4">
                            <div class="form-group">
                                <label for="disabledTextInputLicensePlate">ทะเบียนรถ</label>
                                <input type="text" class="form-control" id="disabledTextInputLicensePlate" placeholder="กก-1111">
                            </div>
                        </fieldset>
                    </div>

                    <!-- ROW 2 : ผู้ขับรถ, Job -->
                    <div class="form-row">
                        <fieldset disabled class="col-sm-12 col-md-6">
                            <div class="form-group">
                                <label for="disabledTextInputDriver">ผู้ขับรถ</label>
                                <input type="text" class="form-control" id="disabledTextInputDriver" placeholder="Sarit T.">
                            </div>
                        </fieldset>
                        <div class="form-group col-sm-12 col-md-6">
                            <label for="inputJob">Job</label>
                            <input type="text" class="form-control" id="inputJob" placeholder="Jxx-xxxx">
                        </div>
                    </div>

                    <!-- ROW 3 : เวลาเริ่มต้น, เวลาสิ้นสุด -->
                    <div class="form-row">
                        <div class="form-group col-sm-12 col-md-6">
                            <label for="inputTimeStart">เวลาเริ่มต้น</label>
                            <input type="time" class="form-control" id="inputTimeStart" placeholder="Jxx-xxxx">
                        </div>
                        <div class="form-group col-sm-12 col-md-6">
                            <label for="inputTimeStop">เวลาสิ้นสุด</label>
                            <input type="time" class="form-control" id="inputTimeStop" placeholder="Jxx-xxxx">
                        </div>
                    </div>

                    <!-- ROW 4 : การเดินทาง, ระยะทาง -->
                    <div class="form-row">
                        <div class="form-group col-sm-12 col-md-9">
                            <label for="inputDestination">การเดินทาง</label>
                            <input type="text" class="form-control" id="inputDestination" placeholder="Ex. Home-CTL(HQ)-Home">
                        </div>
                        <div class="form-group col-sm-12 col-md-3">
                            <label for="inputDistance">ระยะทาง</label>
                            <div class="input-group">
                                <input type="text" class="form-control" style="text-align:end" id="inputDistance" placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text">กม.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ROW 5 : เลขไมล์เริ่มต้น, เลขไมล์สิ้นสุด -->
                    <div class="form-row">
                        <div class="form-group col-sm-12 col-md-6">
                            <label for="inputMileageStart">เลขไมล์เริ่มต้น</label>
                            <input type="text" class="form-control" id="inputMileageStart">
                        </div>
                        <div class="form-group col-sm-12 col-md-6">
                            <label for="inputMileageStop">เลขไมล์สิ้นสุด</label>
                            <input type="text" class="form-control" id="inputMileageStop">
                        </div>
                    </div>

                    <!-- ROW 6 : Fleet Card, Cash -->
                    <div class="form-row ">
                        <div class="form-group col-sm-12 col-md-6">
                            <label for="inputFleetCard">ค่าน้ำมัน (Fleet Card)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" style="text-align:end" id="inputFleetCard" placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text">฿</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-sm-12 col-md-6">
                            <label for="inputCash">ค่าน้ำมัน (เงินสด)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" style="text-align:end" id="inputCash" placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text">฿</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ROW 7 : ค่าทางด่วน, ค่าใช้จ่ายอื่นๆ -->
                    <div class="form-row ">
                        <div class="form-group col-sm-12 col-md-6">
                            <label for="inputExpresswayTolls">ค่าทางด่วน</label>
                            <div class="input-group">
                                <input type="text" class="form-control" style="text-align:end" id="inputExpresswayTolls" placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text">฿</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-sm-12 col-md-6">
                            <label for="inputOther">ค่าใช้จ่ายอื่นๆ</label>
                            <div class="input-group">
                                <input type="text" class="form-control" style="text-align:end" id="inputOther" placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text">฿</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ROW 8 : อัปเดตล่าสุด, ผู้ดำเนินการ, สถานะ -->
                    <div class="form-row ">
                        <fieldset disabled class="col-sm-12 col-md-4">
                            <div class="form-group">
                                <label for="disabledTextInputLastUpdated">อัปเดตล่าสุด</label>
                                <input type="text" class="form-control" id="disabledTextInputLastUpdated" placeholder="08/10/25 09:34">
                            </div>
                        </fieldset>
                        <fieldset disabled class="col-sm-12 col-md-4">
                            <div class="form-group">
                                <label for="disabledTextInputAdmin">ผู้ดำเนินการ</label>
                                <input type="text" class="form-control" id="disabledTextInputAdmin" placeholder="Kriangkrai R.">
                            </div>
                        </fieldset>
                        <fieldset disabled class="col-sm-12 col-md-4">
                            <div class="form-group">
                                <label for="disabledTextInputStatus">สถานะ</label>
                                <input type="text" class="form-control" id="disabledTextInputStatus" placeholder="Manager Pending">
                            </div>
                        </fieldset>
                    </div>
                </form>
            </div>
            <!-- Footer Button -->
            <div class="modal-footer kanit-regular">
                <button type="button" class="btn btn-outline-danger col-sm-3 col-md-2" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" data-dismiss="modal">
                    ยกเลิก
                </button>
                <button type="button" id="BtnSaveChange" class="btn btn-primary col-sm-3 col-md-3" style="border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    บันทึก
                </button>
            </div>
        </div>
    </div>
</div>

<partial name="ModalSpin" />

@section Scripts {

    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script>
        let personals = [];
        var table_personal;
        $(document).ready(async function () {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            $('#date_start').val(formatDateForInput(firstDay));
            $('#date_end').val(formatDateForInput(lastDay));

            const driver = await Getdrivers();
            GenerateDriverOption(driver);

        });

        function formatDateForInput(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0'); // เดือน +1 เพราะเริ่มจาก 0
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }


        async function LoadPersonalCarTable(emp_id, start, stop) {
            const data = await GetPersonalCar(emp_id, start, stop);
            table_personal = $('#table_personal').DataTable({
                destroy: true,
                data: data,
                order: [[0, 'asc']],
                paging: false,
                info: false,
                searching: false,
                drawCallback: function () {
                    mergeDateRows();
                },
                footerCallback: function (row, data, start, end, display) {
                    const api = this.api();

                    const sum = (columnIndex) => {
                        return api.column(columnIndex, { page: 'all' }).data().reduce((a, b) => {
                            return a + (parseFloat(b) || 0);
                        }, 0);
                    };

                    const totalCTBO = sum(5);
                    const totalEXP = sum(6);
                    const totalPT = sum(7);
                    const totalKM = sum(10);

                    $('#totalCTBO').html(totalCTBO.toLocaleString('th-TH', { minimumFractionDigits: 0 }));
                    $('#totalEXP').html(totalEXP.toLocaleString('th-TH', { minimumFractionDigits: 0 }));
                    $('#totalPT').html(totalPT.toLocaleString('th-TH', { minimumFractionDigits: 0 }));
                    $('#totalKM').html(totalKM.toLocaleString('th-TH')).css({
                        'vertical-align': 'middle',
                        'font-size': '20px',
                        'text-align': 'center'
                    });
                },
                columns: [
                    { data: 'dateDisplay', className: 'text-center fw-bold' },
                    { data: 'job' ,className: 'text-center' },
                    {
                        data: 'timeStart', className: 'text-center',
                        render: function (data) {
                            return data === "00:00" ? '' : data;
                        }
                    },
                    {
                        data: 'timeStop', className: 'text-center',
                        render: function (data) {
                            return data === "00:00" ? '' : data;
                        }
                    },
                    { data: 'location' },
                    {
                        data: 'ctbo',
                        className: 'text-center',
                        render: function (data) {                           
                            return data || '';
                        }
                        //render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'exp',
                        className: 'text-center',
                        render: function (data) {
                            return data || '';
                        }
                        //render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'pt',
                        className: 'text-center',
                        render: function (data) {
                            return data || '';
                        }
                        //render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'mileage_start',
                        className: 'text-center',
                        render: function (data) {
                            return data || '';
                        }
                        //render: $.fn.dataTable.render.number(',', '.', 0)
                    },
                    {
                        data: 'mileage_stop',
                        className: 'text-center',
                        render: function (data) {
                            return data || '';
                        }
                        //render: $.fn.dataTable.render.number(',', '.', 0)
                    },
                    {
                        data: 'km',
                        className: 'text-center fw-bold',
                        render: function (data) {
                            return data || '';
                        }
                        //render: data => data ? data.toLocaleString('th-TH') : '0'
                    },
                    {
                        data: null,
                        className: 'text-center fw-bold',
                        defaultContent: '',
                    },
                    { data: 'description' },
                    {
                        data: 'status',
                        className: 'text-center',
                        render: function (data) {
                            const badges = {
                                'Processing': 'bg-warning',
                                'Approved': 'bg-success',
                                'Pending': 'bg-info'
                            };
                            const cls = badges[data] || 'bg-secondary';
                            return `<span class="badge ${cls}">${data || ''}</span>`;
                        }
                    }
                ]

            });

            $('#table_personal tbody').on('click', 'tr', function () {
                const rowData = table_personal.row(this).data();
                if (!rowData) {
                    const $row = $(this);
                    const prevRowData = table_personal.row($row.prev()).data();
                    if (prevRowData) rowData = prevRowData;
                }

                if (rowData) {
                    $(this).toggleClass('table-selected');
                    console.log(rowData);
                    // Show Modal
                }
            });
            mergeDateRows();
        }

        async function GetPersonalCar(emp_id, start, stop) {
            //$('#SpinModal').modal();
            let response = await $.ajax({
                type: "GET",
                url: '@Url.Action("GetDataPersonalCar", "PersonalCarUser")',
                contentType: "application/json",
                dataType: "json",
                data: { emp_id, start, stop },
            });
           // $('#SpinModal').modal('hide');
            return response.data;
        }

        $('#date_end').on('change', async function () {
            const driver = await Getdrivers();
            GenerateDriverOption(driver);
        });

        $('#btn_search').on('click', function () {
            const emp_id = $('#select_driver').val();
            const start = $('#date_start').val();
            const stop = $('#date_end').val();

            if (emp_id !== "" && emp_id !== null) {
                LoadPersonalCarTable(emp_id, start, stop);
            } else {
                alert('Please Select Driver');
            }           
        });

        async function Getdrivers() {
            let drivers = [];
            const start = $('#date_start').val();
            const stop = $('#date_end').val();
            await $.ajax({
                type: "GET",
                url: '@Url.Action("Getdrivers", "PersonalCarUser")',
                contentType: 'application/x-www-form-urlencoded',
                data: { start, stop },
                success: function (response) {
                    drivers = response;
                }
            });
            return drivers;
        }
        function mergeDateRows() {
            const api = table_personal;
            if (!api || api.rows().count() === 0) return;

            const dateColIdx = 0;
            const sumKmColIdx = 11;

            let currentGroupDate = null;
            let groupRows = [];
            let groupTotalKm = 0;

            api.rows({ page: 'current' }).nodes().to$().each(function () {
                const $row = $(this);
                const rowData = api.row(this).data();
                if (!rowData) return;

                const thisDate = rowData.dateDisplay;

                if (currentGroupDate !== thisDate) {

                    if (groupRows.length > 0) {
                        applyGroupMerge(groupRows, groupTotalKm, dateColIdx, sumKmColIdx);
                    }
                    currentGroupDate = thisDate;
                    groupRows = [$row];
                    groupTotalKm = rowData.km || 0;
                } else {
                    groupRows.push($row);
                    groupTotalKm += rowData.km || 0;
                }
            });

            if (groupRows.length > 0) {
                applyGroupMerge(groupRows, groupTotalKm, dateColIdx, sumKmColIdx);
            }
        }

        function applyGroupMerge(groupRows, totalKm, dateColIdx, sumKmColIdx) {
            const rowCount = groupRows.length;
            const $firstRow = groupRows[0];

            $firstRow.find('td').eq(dateColIdx)
                .attr('rowspan', rowCount)
                .css({ 'vertical-align': 'middle', 'background-color': '#e3f2fd', 'font-weight': '500' });

            if (totalKm === 0) {
                $firstRow.find('td').eq(sumKmColIdx)
                    .attr('rowspan', rowCount)
                    .html(`<strong style="color:#d84315; font-size:1em;"></strong>`)
                    .css({
                        'vertical-align': 'middle',
                        'background-color': '#ffffff',
                        'text-align': 'center'
                    });
            }else{
                $firstRow.find('td').eq(sumKmColIdx)
                .attr('rowspan', rowCount)
                .html(`<strong style="color:#d84315; font-size:1em;">${totalKm.toLocaleString('th-TH')}</strong>`)
                .css({
                    'vertical-align': 'middle',
                    'background-color': '#ffffff',
                    'text-align': 'center',
                    'font-weight': '500'
                });
            }

            if (rowCount > 1) {
                for (let i = 1; i < groupRows.length; i++) {
                    groupRows[i].find('td').eq(dateColIdx).remove();
                    groupRows[i].find('td').eq(sumKmColIdx).remove();
                }
            }
        }

        async function GenerateDriverOption(drivers) {
            $('#select_driver').empty();
            $('#select_driver').append(`<option value="" selected disabled>Please Select Driver</option>`);
            for (let i = 0; i < drivers.length; i++) {
                $('#select_driver').append(`<option value="${drivers[i].emp_id}">${drivers[i].name}</option>`);
            }
        }
    </script>
}